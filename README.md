QWC Legend Service v2
=====================

Acts as a proxy between the client and the OGC service for GetLegendGraphic request,
allowing to return custom legend graphics instead of the ones generated by the WMS server.

**v2** (WIP): add support for multitenancy and replace QWC Config service with static config and permission files.


Configuration
-------------

Place your custom legend images in

    $QWC2_PATH/assets/legend/<mapid>/<layername>.png
    $QWC2_PATH/assets/legend/<mapid>/<layername>_thumbnail.png

where

 * `$QWC2_PATH` is the value of the `QWC2_PATH` environment variable
 * `<mapid>` is the id of the WMS map containing the layer
 * `<layername>` is the WMS layer name

The service accepts a `type` query-parameter to distinguish three types of legend graphics:

 - `type=thumbnail`: Image for the thumbnails in the QWC2 layer tree
 - `type=tooltip`: Image for the tooltips when hovering over the thumbnails in the QWC2 layer tree
 - `type=default`: Default image, i.e. in the legend print or in the layer info dialog

The following matrix specifies the behaviour of the service:

Type        | `<layername>`_thumbnail.png | `<layername>`.png  | Result
:-----------|:----------------------------|:-------------------|:--------------------
`thumbnail` | Missing or empty            | Missing or empty   | Autogenerated by WMS
`thumbnail` | Missing or empty            | Available nonempty | `<layername>`.png
`thumbnail` | Available, non-empty        | Doesn't matter     | `<layername>`_thumbnail.png
`tooltip`   | Doesn't matter              | Missing            | Autogenerated by WMS
`tooltip`   | Doesn't matter              | Empty (0 KB)       | No tooltip
`tooltip`   | Doesn't matter              | Available nonempty | `<layername>`.png
`default`   | Doesn't matter              | Available nonempty | `<layername>`.png
`default`   | Doesn't matter              | Missing or empty   | Autogenerated by WMS

Note that the file type must be `png`.


Usage
-----

Set the `OGC_SERVICE_URL` environment variable to the OGC service URL (default: `http://localhost:5013/`).
Set the `QWC2_PATH` environment variable to the path containing your QWC2 production build.


Base URL:

    http://localhost:5014/

API documentation:

    http://localhost:5014/api/

Sample request:

    http://localhost:5014/<mapid>?SERVICE=WMS&REQUEST=GetLegendGraphic&LAYER=<layername>&format=image/png&....

Development
-----------

Create a virtual environment:

    virtualenv --python=/usr/bin/python3 --system-site-packages .venv

Without system packages:

    virtualenv --python=/usr/bin/python3 .venv

Activate virtual environment:

    source .venv/bin/activate

Install requirements:

    pip install -r requirements.txt
    pip install flask_cors

Start local service:

    OGC_SERVICE_URL=http://localhost:5013 QWC2_PATH=qwc2/ python server.py
